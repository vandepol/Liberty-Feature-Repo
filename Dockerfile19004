FROM websphere-liberty

USER 1001:0
COPY larsServerPackage.jar /tmp/

COPY --chown=1001:0 larsClient /tmp/larsClient
COPY --chown=1001:0 featureRepo19.0.0.4 /featureRepo


RUN /opt/ibm/wlp/bin/installUtility install --acceptLicense --from=/featureRepo \
com.ibm.websphere.appserver.mongodb-2.0 \
com.ibm.websphere.appserver.cdi-1.0 \
com.ibm.websphere.appserver.jaxrs-1.1

RUN java -jar /tmp/larsServerPackage.jar --acceptLicense /opt/ibm/wlp
COPY server.xml /opt/ibm/wlp/usr/servers/larsServer/server.xml

USER root
RUN apt-get update && apt-get install -y mongodb

RUN mkdir -p /data/db
RUN chmod 755 /data/db
RUN chown 1001 /data/db
RUN chmod  777 /
USER 1001:0


USER root
RUN mongod & sleep 10s && /opt/ibm/wlp/bin/server start larsServer && /tmp/larsClient/bin/larsClient upload /featureRepo/features/19.0.0.4/*.esa --url=http://localhost:9080/ma/v1 --username=admin --password=admin 
#RUN /opt/ibm/wlp/bin/server stop larsServer

RUN rm -rf /featureRepo

CMD ["sh", "-c", "mongod  & /opt/ibm/wlp/bin/server run larsServer"]

